# Выбор и настройка мониторинга в системе

## Мотивация

Внедрение комплексной системы мониторинга в инфраструктуру является критически важным шагом по нескольким причинам:

1. **Выявление причин потери заказов** — основная бизнес-проблема компании заключается в потере заказов и недовольстве клиентов. Без мониторинга мы не можем точно определить, на каком этапе и почему происходит сбой.

2. **Обеспечение прозрачности бизнес-процессов** — мониторинг позволит получить единую картину прохождения заказа через все системы: от онлайн-магазина через CRM до MES и обратно.

3. **Управление растущей нагрузкой** — компания расширяется, ежемесячно количество заказов увеличивается на 100. Открытие API для B2B партнеров создало дополнительную нагрузку. Система мониторинга поможет определить узкие места и понять, где необходимо горизонтальное масштабирование.

4. **Сокращение времени реакции на инциденты** — система мониторинга позволит быстро выявлять проблемы и реагировать на них до того, как они повлияют на клиентов.

5. **Обоснование архитектурных решений** — мониторинг предоставит объективные данные для принятия решений о модернизации архитектуры, основанных не на предположениях, а на конкретных метриках.

6. **Финансовая выгода** — предотвращение потери клиентов и контрактов напрямую влияет на выручку компании. Компания уже потеряла несколько крупных контрактов из-за проблем с заказами.

## Выбор подхода к мониторингу

Для эффективного мониторинга различных компонентов системы предлагаю использовать комбинированный подход:

### 1. RED-метод для всех пользовательских сервисов

**RED-метод (Rate, Errors, Duration)** будет применяться для всех сервисов, с которыми напрямую взаимодействуют пользователи:
- Онлайн-магазин (интерфейс и API)
- CRM API
- MES API
- Shop API

Этот подход ориентирован на пользовательский опыт и поможет быстро выявлять проблемы, влияющие на клиентов.

### 2. USE-метод для инфраструктуры

**USE-метод (Utilization, Saturation, Errors)** будет применяться для мониторинга инфраструктуры:
- EC2 инстансы всех приложений
- Базы данных PostgreSQL
- RabbitMQ
- S3-хранилище для 3D-файлов

Этот подход позволит контролировать состояние ресурсов и предупреждать о потенциальных проблемах до того, как они повлияют на пользователей.

### 3. Четыре золотых сигнала для бизнес-процессов

**Четыре золотых сигнала (Latency, Traffic, Errors, Saturation)** будут использоваться для мониторинга бизнес-процессов и их эффективности:
- Процесс создания заказа
- Процесс расчета стоимости
- Процесс производства
- Процесс доставки

Этот подход позволит отслеживать эффективность бизнес-процессов в целом.

## Метрики для мониторинга

### Метрики для пользовательских сервисов (RED)

#### 1. Количество запросов (Rate)

**Метрика**: `http_requests_total`

**Зачем нужна**: Позволяет отслеживать общий трафик системы, выявлять аномалии и планировать масштабирование. Резкое падение запросов может указывать на недоступность сервиса для пользователей.

**Ярлыки**:
- `service` (shop, crm, mes, shop_api, crm_api, mes_api)
- `endpoint` (путь API или страница)
- `method` (GET, POST, PUT, DELETE)
- `status_code` (200, 404, 500 и т.д.)
- `user_type` (anonymous, authenticated, b2b_partner)

#### 2. Доля ошибок (Errors)

**Метрика**: `http_request_errors_percentage`

**Зачем нужна**: Позволяет быстро выявлять проблемы в работе сервисов. Увеличение процента ошибок прямо влияет на пользовательский опыт и может указывать на проблемы с интеграцией или производительностью.

**Ярлыки**:
- `service` (shop, crm, mes, shop_api, crm_api, mes_api)
- `endpoint` (путь API или страница)
- `error_type` (client_error, server_error, timeout)
- `user_type`

#### 3. Время обработки запросов (Duration)

**Метрика**: `http_request_duration_seconds`

**Зачем нужна**: Позволяет выявлять узкие места в производительности. Увеличение времени обработки запросов напрямую влияет на пользовательский опыт.

**Ярлыки**:
- `service` (shop, crm, mes, shop_api, crm_api, mes_api)
- `endpoint` (путь API или страница)
- `method` (GET, POST, PUT, DELETE)
- `percentile` (0.5, 0.9, 0.95, 0.99)

### Метрики для инфраструктуры (USE)

#### 4. Использование CPU (Utilization)

**Метрика**: `cpu_usage_percentage`

**Зачем нужна**: Позволяет определять нагрузку на сервера и планировать масштабирование. Высокая загрузка CPU может привести к замедлению работы приложений.

**Ярлыки**:
- `instance`
- `service` (shop, crm, mes, database)

#### 5. Использование памяти (Utilization)

**Метрика**: `memory_usage_percentage`

**Зачем нужна**: Помогает выявлять утечки памяти и необходимость в вертикальном масштабировании. Критичная нехватка памяти может привести к сбоям в работе.

**Ярлыки**:
- `instance`
- `service` (shop, crm, mes, database)

#### 6. Загрузка дисковой подсистемы (Saturation)

**Метрика**: `disk_io_utilization`

**Зачем нужна**: Особенно важна для баз данных. Высокая загрузка I/O может указывать на неоптимальные запросы или необходимость в оптимизации хранения.

**Ярлыки**:
- `instance`
- `service` (shop, crm, mes, database)
- `disk_type` (system, data)

#### 7. Сетевой трафик (Utilization)

**Метрика**: `network_traffic_bytes`

**Зачем нужна**: Позволяет отслеживать объемы передаваемых данных между компонентами системы и выявлять узкие места в сети.

**Ярлыки**:
- `instance`
- `service` (shop, crm, mes, database)
- `direction` (in, out)

### Метрики для баз данных

#### 8. Количество активных соединений

**Метрика**: `db_connections_active`

**Зачем нужна**: Позволяет контролировать нагрузку на базы данных и выявлять проблемы с пулами соединений в приложениях.

**Ярлыки**:
- `database` (shop_db, crm_db, mes_db)
- `service` (shop, crm, mes)

#### 9. Время выполнения запросов

**Метрика**: `db_query_duration_seconds`

**Зачем нужна**: Помогает выявлять медленные запросы, требующие оптимизации. Критичная метрика для оптимизации работы MES при загрузке списка заказов.

**Ярлыки**:
- `database`
- `query_type` (select, insert, update, delete)
- `table`
- `percentile` (0.5, 0.9, 0.95, 0.99)

### Метрики для очередей сообщений (RabbitMQ)

#### 10. Общее количество сообщений

**Метрика**: `messages`

**Зачем нужна**: Позволяет контролировать общее количество сообщений (готовых к доставке и неподтвержденных) в очередях. Рост этого показателя может указывать на проблемы с обработкой сообщений.

**Ярлыки**:
- `queue_name`
- `vhost`
- `node`

#### 11. Количество сообщений, готовых к доставке

**Метрика**: `messages_ready`

**Зачем нужна**: Отслеживает количество сообщений, которые готовы к доставке потребителям. Большое количество таких сообщений может указывать на отсутствие активных потребителей или их недостаточную производительность.

**Ярлыки**:
- `queue_name`
- `vhost`
- `node`

#### 12. Количество неподтвержденных сообщений

**Метрика**: `messages_unacknowledged`

**Зачем нужна**: Показывает количество сообщений, доставленных потребителям, но еще не подтвержденных. Большое количество неподтвержденных сообщений может указывать на проблемы в обработке на стороне потребителя.

**Ярлыки**:
- `queue_name`
- `vhost`
- `node`

### Метрики для бизнес-процессов

#### 13. Количество заказов по статусам

**Метрика**: `orders_count_by_status`

**Зачем нужна**: Позволяет контролировать движение заказов по этапам обработки и выявлять «узкие места» в бизнес-процессе.

**Ярлыки**:
- `status` (все статусы заказа)
- `source` (online, b2b_api)
- `has_3d_model` (yes, no)

#### 14. Время расчета стоимости

**Метрика**: `price_calculation_duration_seconds`

**Зачем нужна**: Критически важная метрика для выявления проблем с производительностью системы расчета стоимости изделий.

**Ярлыки**:
- `model_complexity` (low, medium, high) - можно высчитывать на основе количества полигонов
- `calculation_result` (success, error, timeout)
- `source` (online, b2b_api)

#### 15. Время прохождения заказа через все этапы

**Метрика**: `order_processing_total_time`

**Зачем нужна**: Позволяет контролировать общую эффективность бизнес-процесса и соответствие SLA.

**Ярлыки**:
- `source` (online, b2b_api)
- `has_3d_model`
- `operator_id` (для выявления различий в эффективности операторов)

#### 16. Застрявшие заказы

**Метрика**: `stack_orders_count`

**Зачем нужна**: Ключевая метрика для решения основной проблемы компании - "зависших" заказов. Заказ считается зависшим, если он не переходит в следующий статус в течение определенного времени (например, 3 дня).

**Ярлыки**:
- `last_status` (последний известный статус заказа)
- `source` (online, b2b_api)
- `expected_next_status` (ожидаемый следующий статус)

### Специфические метрики для 3D-моделей

#### 17. Количество полигонов в модели

**Метрика**: `3d_model_polygon_count`

**Зачем нужна**: Прямо влияет на время расчета стоимости. Помогает оптимизировать процесс расчета.

**Ярлыки**:
- `complexity_level` (low, medium, high)
- `source` (online, b2b_api, configurator)

## План действий

Для внедрения системы мониторинга предлагается использовать следующий стек технологий:

1. **Prometheus** - для сбора и хранения метрик и настройки оповещений
2. **Grafana** - для визуализации метрик и создания дашбордов
3. **OpenTelemetry** - для сбора, обработки и экспорта телеметрических данных-сигналов (метрик, трассировок и журналов)

План внедрения:

1. Внедрение сбора метрик, логов, и трейсингаважных компонентов (Shop API, CRM API, MES) c OpenTelemetry
2. Настройка мониторинга инфраструктуры
3. Создание основных дашбордов для отслеживания ключевых метрик
4. Настройка оповещений для критичных ситуаций
5. Внедрение сбора метрик, логов, и трейсинг остальных компонентов системы
6. Создание специализированных дашбордов
