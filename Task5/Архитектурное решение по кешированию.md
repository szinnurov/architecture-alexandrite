# Архитектурное решение по кешированию

## 1. Мотивация

1. **Ускорение отображения информации** — уменьшение времени загрузки списков заказов в интерфейсе MES для операторов
2. **Снижение времени расчета стоимости** — кеширование результатов расчетов для уменьшения времени отклика
3. **Уменьшение нагрузки на базы данных** — снижение количества повторяющихся запросов к MES DB
4. **Сокращение времени обработки заказов** — ускорение процесса назначения и работы с заказами

## 2. Предлагаемое решение

### 2.1 Выбор стратегии кеширования

Для решения выявленных проблем предлагается комбинированный подход к кешированию, включающий как **серверное**, так и **клиентское** кеширование:

#### 2.1.1 Серверное кеширование

Для серверного кеширования будет использован **паттерн Cache-Aside** для следующих данных:

- Списки заказов
- Результаты расчета стоимости
- Детальная информация о заказах
- Статистические данные


| Паттерн | Преимущества | Недостатки | Применимость |
|---------|--------------|------------|--------------|
| **Cache-Aside** | - Кеширование только запрашиваемых данных<br>- Снижение нагрузки на БД<br>- Простота реализации<br>- Хорошо работает при нечастом обновлении данных | - Возможность получения устаревших данных<br>- Необходимость проверки кеша перед каждым обращением к БД | **Оптимален для MES API**<br>- Запросы чтения преобладают над записью<br>- Не все данные нужно кешировать<br>- Требуется быстрый доступ к часто запрашиваемым данным |
| Write-Through | - Данные в кеше всегда актуальны<br>- Упрощенная логика инвалидации | - Увеличенное время операций записи<br>- Кеширование всех данных, даже редко запрашиваемых | **Не подходит для MES**<br>- Замедлит изменение статусов заказов<br>- Избыточное кеширование всех данных |
| Refresh-Ahead | - Предзагрузка данных до истечения TTL<br>- Минимизация промахов кеша | - Сложность прогнозирования<br>- Повышенная нагрузка на систему при обновлении<br>- Сложная реализация | **Частично применим**<br>- Может использоваться для списков заказов<br>- Но усложнит систему и потребует дополнительных ресурсов |

#### 2.1.2 Клиентское кеширование

Для клиентской части MES-интерфейса можно реализовать:

- Кеширование статических ресурсов (например, изображения)
- Локальное хранение часто используемых данных в browser storage

### 2.2 Диаграмма последовательности


#### 2.2.1 Операция чтения списка заказов с кешированием

![read-order](/files/read-order.png)

#### 2.2.2 Операция изменения статуса заказа

![read-status](/files/read-status.png)

### 2.3 Стратегия инвалидации кеша

#### 2.3.1 Сравнительный анализ стратегий инвалидации

| Стратегия | Описание | Преимущества | Недостатки | Применимость |
|-----------|----------|--------------|------------|--------------|
| **Инвалидация по ключу** | Удаление конкретных записей кеша при изменении соответствующих данных | - Высокая точность<br>- Минимальная потеря данных кеша<br>- Контроль над жизненным циклом кеша | - Требует дополнительной логики при изменении данных<br>- Сложность отслеживания зависимостей между данными | **Оптимальна для детальной информации о заказах**<br>- При изменении статуса заказа<br>- При обновлении расчетов стоимости |
| **Временная инвалидация (TTL)** | Автоматическое удаление данных из кеша по истечении заданного времени | - Простота реализации<br>- Не требует дополнительной логики при изменении данных<br>- Автоматическая очистка | - Возможность использования устаревших данных<br>- Избыточные запросы к БД при частых обращениях | **Подходит для списков заказов и статистики**<br>- Для списков с коротким TTL (30-60 секунд)<br>- Для редко меняющихся данных с длинным TTL |
| **Программная инвалидация** | Очистка кеша через API по требованию | - Полный контроль<br>- Возможность массовой инвалидации<br>- Очистка связанных данных | - Сложность реализации<br>- Риск пропустить необходимые инвалидации<br>- Требует дополнительной логики | **Полезна для критических обновлений**<br>- При массовых изменениях<br>- При изменении бизнес-правил |
| **Инвалидация на основе событий** | Удаление данных из кеша при получении определенных событий | - Реактивный подход<br>- Хорошая масштабируемость<br>- Низкая связность компонентов | - Сложность отслеживания<br>- Возможны задержки<br>- Требует инфраструктуры для событий | **Эффективна для межсервисных взаимодействий**<br>- При сообщениях из RabbitMQ<br>- При изменениях статусов заказов |

#### 2.3.2 Предлагаемая стратегия инвалидации

Предлагается комбинированная стратегия инвалидации:

1. **Инвалидация по ключу** для:
   - Детальной информации о конкретных заказах при изменении их статуса
   - Результатов расчета стоимости при изменении параметров заказа
   - Информации об операторах при изменении их статуса/доступности

2. **Временная инвалидация (TTL)** для:
   - Списков заказов с коротким временем жизни (15 секунд)
   - Статистических данных (15 минут)
   - Результатов расчетов, которые зависят от времени (1 час)

3. **Инвалидация на основе событий** для:
   - Обновления связанных с заказом данных при получении сообщений из RabbitMQ
   - Синхронизации кешей между различными инстансами API при масштабировании

**Обоснование выбора:**

- Обеспечит актуальность критически важных данных (детали заказов, статусы)
- Снизит нагрузку на систему за счет временной инвалидации для часто запрашиваемых, но редко меняющихся данных
- Соблюдет баланс между производительностью и консистентностю данных
