# Архитектурное решение по трейсингу

## Анализ системы и потенциальные точки отказа

### Ключевые компоненты для трейсинга:

1. **Интеграция между CRM и MES через RabbitMQ** — критическая точка, где сообщения могут теряться или обрабатываться с ошибками.

2. **API всех систем**: 
   - Shop API
   - CRM API 
   - MES API
   
3. **Процесс расчета стоимости заказа в MES** — длительные операции (до 30 минут) являются потенциальным местом сбоя.

4. **Процесс загрузки и обработки 3D-моделей** — включая передачу между системами и сохранение в S3-хранилище.

5. **Взаимодействие с базами данных** — запросы в бд.

### Потенциальные точки отказа и риски:

1. **Потеря сообщений в RabbitMQ** — заказы могут "зависать" в процессе передачи между системами.

2. **Таймауты при расчете стоимости** — сложные 3D-модели требуют длительной обработки.

3. **Ошибки синхронизации статусов заказа** — статус может не обновляться корректно между системами.

4. **Перегрузка API внешними партнерами** — после публикации открытого API увеличилась нагрузка и количество проблем.

5. **Медленные запросы к базе данных MES** — особенно при загрузке списка заказов операторами.

## Данные для включения в трейсинг

### Идентификаторы и метаданные:

1. **Идентификатор трейса (trace_id)** — уникальный идентификатор для всей цепочки обработки заказа через все системы.

2. **Идентификатор спана (span_id)** — идентификатор конкретной операции в рамках трейса.

3. **Уникальный идентификатор заказа (order_id)** — основной ключ для связи всех операций с конкретным заказом.

4. **Временные метки (timestamps)** — время начала и окончания каждой операции.

5. **Идентификатор пользователя/клиента** — позволит связать заказ с конкретным пользователем (B2C) или партнером (B2B).

### Контекстная информация:

6. **Текущий статус заказа** — все изменения статуса (INITIATED, FILE_UPLOADED, SUBMITTED и т.д.).

7. **Тип заказа** — стандартный или с загрузкой пользовательской 3D-модели.

8. **Источник заказа** — онлайн-магазин или через API-партнера.

### Технические данные:

9. **HTTP-коды ответа** — для всех API-запросов.

10. **Идентификаторы сообщений в RabbitMQ** — для отслеживания прохождения сообщений через очередь.

11. **Время выполнения операций** — особенно расчета стоимости и загрузки 3D-моделей.

12. **Информация об ошибках** — тип ошибки, сообщение, стек вызовов.

13. **Метаданные инфраструктуры** — какой инстанс обрабатывал запрос.

## Мотивация

Внедрение распределенного трейсинга в инфраструктуру компании важное решением для устранения ключевой бизнес-проблемы — потери заказов и их зависания в неопределенном состоянии. 

### Бизнес-преимущества трейсинга:

1. **Снижение количества потерянных заказов** — трейсинг позволит точно определить, где именно в цепочке обработки произошел сбой, и вовремя устранить проблему.
2. **Повышение удовлетворенности клиентов** — команда поддержки сможет быстро предоставлять информацию о текущем статусе заказа и причинах возможных задержек.
3. **Сокращение времени на диагностику проблем** — вместо длительного анализа логов и запросов в базы данных разработчики смогут быстро определить место сбоя.

### Ключевые метрики эффективности внедрения трейсинга:

#### Технические метрики:
1. **Среднее время обнаружения проблемы (MTTD)** — ожидаемое сокращение с нескольких часов до минут
2. **Среднее время восстановления (MTTR)** — ожидаемое сокращение времени на устранение найденных проблем
3. **Доля успешно завершенных заказов** — увеличение с текущего уровня
4. **Среднее время обработки заказа** — сокращение времени за счет оптимизации выявленных узких мест
5. **Количество потерянных сообщений в очередях** — устранение этой пробелемы за счет мониторинга и анализа трейсов

## Предлагаемое решение

Для реализации распределенного трейсинга в компании «Александрит» предлагается использовать следующее техническое решение:

### Архитектура системы трейсинга:

1. **OpenTelemetry (OTEL)** в качестве единого стандарта для сбора трейсов во всех компонентах системы:
   - Открытый стандарт, поддерживаемый всеми современными платформами
   - Единый формат для трейсов, метрик и логов
   - Поддержка как Java (Spring Boot), так и C# компонентов системы
   - Возможность плавного внедрения без существенных изменений в архитектуре

2. **Jaeger** в качестве системы сбора, хранения и визуализации трейсов:
   - Высокопроизводительная система с поддержкой масштабирования
   - Богатые возможности визуализации и анализа распределенных трейсов
   - Интеграция с Prometheus для мониторинга
   - Поддержка запросов к данным трейсинга

3. **Интеграция с существующими системами**:
   - Автоматическая профилирование Java-компонентов с использованием Spring Boot + OpenTelemetry
   - Профилирование C# компонентов (MES) с использованием OpenTelemetry SDK для .NET
   - Установка компонентов сбора трейсов (OTEL Collector) для передачи данных в Jaeger

### Обновленная архитектурная схема:

![Диаграмма компонентов](/files/alexandrite-tracing-c4.puml.png)

*Примечание: На диаграмме красным цветом выделены новые компоненты и связи, добавленные для реализации трейсинга.*


## Компромиссы

При внедрении распределенного трейсинга необходимо учитывать следующие ограничения и компромиссы:

### Технические ограничения:

1. **Производительность**:
   - Трейсинг создает дополнительную нагрузку на систему
   - Для MES, где уже есть проблемы с производительностью, потребуется тщательная настройка семплирования
   - Компромисс: внедрение адаптивного семплирования, при котором в пиковые часы собирается только часть трейсов

2. **Хранение данных**:
   - Полноценный трейсинг всех операций требует значительных объемов хранилища
   - Компромисс: хранение полных трейсов только для заказов с ошибками. Другой вариант: хранить все трейсы 1 месяц и переводить в долговременное хранилище трейсы, по которым был запрос (при расследовании инцидентов).

### Организационные ограничения:

3. **Приоритизация**:
   - Невозможно одновременно покрыть трейсингом все компоненты
   - Компромисс: начать с критических точек интеграции (RabbitMQ, API) и постепенно расширять покрытие

### Случаи, когда трейсинг неэффективен:

1. **Внешние системы**:
   - Транспортные компании и другие внешние партнеры не будут передавать контекст трейсинга
   - Ограничение: для таких интеграций трейсинг будет заканчиваться на границе системы

2. **Исторические данные**:
   - Трейсинг не поможет с анализом уже случившихся проблем до его внедрения
   - Ограничение: необходимо дополнительно анализировать исторические логи

## Безопасность

Внедрение системы трейсинга требует особого внимания к аспектам безопасности, поскольку трейсы могут содержать чувствительную информацию:

### Защита данных:

1. **Фильтрация чувствительной информации**:
   - Автоматическая маскировка персональных данных в трейсах
   - Исключение информации о платежах, паролей и других чувствительных данных
   - Настройка правил санитизации данных на уровне OpenTelemetry Collector

2. **Шифрование**:
   - Шифрование данных при передаче (TLS)
   - Шифрование данных при хранении в Elasticsearch

3. **Хранение и срок жизни данных**:
   - Автоматическое удаление трейсов старше 30 дней
   - Агрегация и анонимизация данных для долгосрочного хранения

### Контроль доступа:

4. **Аутентификация**:
   - Многофакторная аутентификация для доступа к системе трейсинга
   - Журналирование всех попыток доступа

5. **Авторизация и разделение ролей**:
   - Роль "Разработчик" — полный доступ к трейсам для отладки и оптимизации
   - Роль "Администратор" — управление настройками и пользователями системы

### Аудит и мониторинг безопасности:

6. **Аудит действий пользователей**:
   - Регистрация всех запросов к системе трейсинга
   - Регулярные проверки журналов аудита
