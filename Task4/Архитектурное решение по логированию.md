# Архитектурное решение по логированию

## Анализ систем для сбора логов

1. **Messages Queue (RabbitMQ)** — ключевой компонент для передачи сообщений между системами, место, где часто теряются заказы.
2. **Shop API** — основной интерфейс для создания заказов и загрузки 3D-моделей.
3. **CRM API** — обеспечивает взаимодействие между продавцами и заказами.
4. **MES API** — критичная система, отвечающая за расчет стоимости и распределение заказов.
5. **Internet Shop** — пользовательский интерфейс для создания заказов.
6. **CRM** — интерфейс для работы продавцов.
7. **MES** — интерфейс для операторов и модуль расчета стоимости.
8. **3d files storage** — хранилище 3D-моделей, проблемы с которым могут привести к потере файлов.
9. **Shop DB** — хранит информацию о заказах и клиентах.
10. **MES db** — хранит информацию о производстве.

## Необходимые логи уровня INFO

### 1. Messages Queue (RabbitMQ)

- **Отправка сообщения в очередь**:
  - Время события
  - Идентификатор сообщения
  - Источник сообщения (сервис-отправитель)
  - Размер сообщения

- **Получение сообщения из очереди**:
  - Время события
  - Идентификатор сообщения
  - Получатель (сервис)
  - Результат обработки (успех/ошибка)
  - Время в очереди

### 2. Shop API

- **Создание заказа**:
  - Время события
  - Идентификатор заказа
  - Идентификатор клиента
  - IP-адрес клиента
  - User-Agent
  
- **Загрузка 3D-модели**:
  - Время события
  - Идентификатор заказа
  - Размер файла
  - Результат загрузки
  
- **Изменение статуса заказа**:
  - Время события
  - Идентификатор заказа
  - Предыдущий статус
  - Новый статус
  - Инициатор изменения

### 3. CRM API

- **Подтверждение заказа**:
  - Время события
  - Идентификатор заказа
  - Идентификатор продавца
  
- **Отправка заказа в производство**:
  - Время события
  - Идентификатор заказа
  - Идентификатор продавца
  
- **Изменение статуса заказа**:
  - Время события
  - Идентификатор заказа
  - Предыдущий статус
  - Новый статус
  - Инициатор изменения

### 4. MES API

- **Расчет стоимости**:
  - Длительность расчета
  - Идентификатор заказа
  - Количество полигонов в модели
  - Результат расчета (успех/ошибка)
  - Рассчитанная стоимость
  
- **Назначение заказа на оператора**:
  - Время события
  - Идентификатор заказа
  - Идентификатор оператора
  
- **Изменение статуса производства**:
  - Время события
  - Идентификатор заказа
  - Предыдущий статус
  - Новый статус
  - Инициатор изменения

### 5. Фронтенд-приложения (Internet Shop, CRM, MES)

- **Действия пользователя**:
  - Время события
  - Тип действия (вход, создание заказа, просмотр и т.д.)
  - Идентификатор пользователя
  - Сессия пользователя
  - Результат действия
  
- **Ошибки клиентской части**:
  - Время события
  - Тип ошибки
  - Стек вызовов

### 6. Базы данных

- **Длительные запросы**:
  - Длительность выполнения
  - Текст запроса
  - Источник запроса (сервис)

## Уровни логирования

Помимо INFO уровня, необходимо настроить сбор логов следующих уровней:

### 1. ERROR
Логи этого уровня требуется собирать для любых ошибок в логике кода.

### 2. WARN
Логи уровня WARN можно собирать для:
- Долгих операций
- Повторных попыток выполнения операций

### 3. DEBUG
Можно использовать:
- В тестовых/релизных окружениях
- При расследовании сложных проблем
- На ограниченное время для конкретных компонентов
- Для новых функциональностей до подтверждения стабильности

### 4. TRACE
Можно использовать:
- В разработке
- При детальном расследовании конкретных проблем

## Мотивация

Внедрение централизованной системы логирования в инфраструктуру компании «Александрит» является критически важным решением для устранения текущих проблем с диагностикой ошибок и длительным расследованием инцидентов.

### Текущие проблемы:

1. **Диагностика на основе субъективных сведений от клиентов** — разбор проблем осуществляется со слов клиентов, что не даёт полной и объективной картины.
2. **Длительное время расследования инцидентов** — специалистам поддержки и разработчикам требуется много времени на определение причин ошибок.
3. **Отсутствие видимости жизненного цикла заказа** — невозможность отследить перемещение заказа между системами и изменение его статусов.
4. **Сложность в выявлении системных ошибок** — без централизованных логов трудно определить повторяющиеся шаблоны проблем.
5. **Высокая нагрузка на службу поддержки** — специалисты тратят значительные ресурсы на расследование инцидентов без достаточного инструментария.

### Преимущества внедрения:

1. **Быстрая диагностика проблем** — с логами гораздо легче определить, на каком этапе произошла ошибка.
2. **Проактивное выявление проблем** — мониторинг логов и настройка алертов позволят выявлять проблемы до того, как о них сообщат клиенты.
3. **Снижение нагрузки на поддержку** — автоматизация анализа логов и быстрый доступ к информации сократят время обработки обращений.
4. **Данные для оптимизации системы** — анализ логов позволит выявлять узкие места и системные проблемы для последующего улучшения.
5. **Аудит действий пользователей и систем** — возможность отследить полную историю заказа от создания до доставки.

### Ключевые метрики эффективности внедрения логирования:

#### Технические метрики:
1. **Время обнаружения проблемы (MTTD)** — ожидаемое сокращение с нескольких часов до минут
2. **Время восстановления (MTTR)** — ожидаемое сокращение с часов до десятков минут
3. **Доступность системы логирования** — время бесперебойной работы системы

#### Бизнес-метрики:
1. **Сокращение времени обработки клиентских обращений** 
2. **Количество жалоб на потерянные заказы** 
3. **Операционные затраты на поддержку** 


## Приоритизация внедрения логирования и трейсинга

### Первая очередь:

1. **RabbitMQ** — логирование + трейсинг
   - Обоснование: Ключевой компонент интеграции, место, где чаще всего теряются заказы.
   - Что дает: Возможность отследить путь сообщений между системами и выявить проблемы с потерей данных.

2. **MES API** — логирование + трейсинг
   - Обоснование: Критичный компонент с длительными операциями расчета стоимости, который часто является источником задержек.
   - Что дает: Возможность оптимизировать производительность и выявить причины задержек в расчетах.

3. **Shop API и CRM API** — логирование
   - Обоснование: Основные точки входа для создания и обработки заказов.
   - Что дает: Полную информацию о жизненном цикле заказа и взаимодействии с клиентами.

### Остальное:

4. **Shop API и CRM API** — трейсинг
   - Обоснование: Расширение возможностей диагностики после внедрения базового логирования.
   - Что дает: Детальное понимание взаимодействия между компонентами и пути заказа.

5. **Базы данных** — логирование
   - Обоснование: Важны для выявления проблем с производительностью запросов.
   - Что дает: Оптимизация запросов и обнаружение узких мест в работе с данными.


## Предлагаемое решение

### Архитектура системы логирования

Для реализации централизованного логирования использовать стек ELK с дополнительными компонентами:

1. **Сбор логов**:
   - **Filebeat** — для сбора логов из файлов (фронтенд-приложения, API)
   - **Metricbeat** — для сбора метрик системы и приложений

2. **Транспорт и обработка**:
   - **Logstash** — для нормализации, фильтрации и обогащения логов

3. **Хранение и анализ**:
   - **Elasticsearch** — для индексации и хранения логов
   - **Kibana** — для визуализации и анализа логов
   - **Grafana** — для создания дашбордов (опционально, для интеграции с Prometheus)

4. **Мониторинг и алертинг**:
   - **Elastalert** — для настройки оповещений на основе логов


###  Архитектурная схема с логированием:

![Диаграмма компонентов с логированием](/files/alexandrite-logging-c4.png)

## Компромиссы

### Технические ограничения:

1. **Проблемы с проприетарными компонентами:**
   - Системы, использующие закрытый код (например, некоторые модули расчета стоимости в MES API), могут не предоставлять достаточных возможностей для интеграции с системой логирования.
   - *Решение:* для таких компонентов можно настроить логирование на уровне входных и выходных данных, без внутренних деталей работы.

2. **Высоконагруженные компоненты:**
   - Включение подробного логирования на критичных с точки зрения производительности компонентах (например, Shop API в периоды высокой нагрузки) может привести к деградации производительности.
   - *Решение:* для таких компонентов необходимо настраивать динамический уровень логирования, который будет снижаться при высокой нагрузке.

### Экономические компромиссы:

1. **Стоимость хранения логов:**
   - Хранение полных логов всех компонентов за длительный период может потребовать значительных ресурсов.
   - *Решение:* внедрение политик времени жизни логов, архивация старых данных.

2. **Баланс между глубиной логирования и затратами:**
   - Чем подробнее логи, тем больше ресурсов требуется на их обработку и хранение.
   - *Решение:* настройка уровней логирования в зависимости от критичности компонента, использование выборочного логирования для некритичных операций.

## Политика безопасности логов

### Обработка чувствительных данных:

1. **Маскирование персональных данных**:
   - Полная или частичная маскировка ПДн (адрес, номер телефона и т.д.)
   - Исключение полных адресов доставки, заменяя их на город/регион

2. **Исключение платежной информации**:
   - Полное исключение данных о платежных картах
   - Исключение банковских реквизитов

3. **Удаление аутентификационных данных**:
   - Полное исключение паролей и токенов
   - Маскирование API-ключей

### Контроль доступа:

1. **Модель ролевого доступа**:
   - **Роль "Разработчик"** — доступ к логам своих сервисов для отладки
   - **Роль "Поддержка"** — доступ к логам, связанным с заказами клиентов
   - **Роль "Администратор системы"** — полный доступ ко всем логам

2. **Аутентификация**:
   - Многофакторная аутентификация для доступа к системе логирования
   - Интеграция с системой управления доступом компании

3. **Аудит доступа**:
   - Логирование всех запросов к системе логирования
   - Логирование выгрузок и экспорта логов

## Политика хранения логов

### Структура хранения:

1. **Индексы Elasticsearch**:
   - Отдельные индексы для различных типов логов:
   - TTL для индексов

2. **Шардирование и репликация**:
   - Настройка оптимального количества шардов в зависимости от объема данных
   - Настройка репликации для обеспечения отказоустойчивости

## Анализ логов и алертинг

### Алертинг:

   - Большое количество ошибок в API (порог: более 10 ошибок в минуту)
   - Долгое время расчета стоимости (порог: более 20 минут)
   - Ошибки при передаче сообщений в RabbitMQ
   - Отсутствие обновления статуса заказа более 24 часов
   - Недоступность сервисов

### Обнаружение аномалий:

   **Анализ паттернов запросов**:
   - Обнаружение потенциальных DDoS-атак по количеству запросов
   - Выявление подозрительной активности (множественные неудачные попытки входа)
   - Анализ географического распределения запросов
